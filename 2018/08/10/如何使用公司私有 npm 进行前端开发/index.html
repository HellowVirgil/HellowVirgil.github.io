<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 如何使用公司私有 npm 进行前端开发 · VirgilZone</title><meta name="description" content="如何使用公司私有 npm 进行前端开发 - Virgil"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://hellowvirgil.github.io/atom.xml" title="VirgilZone"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/HellowVirgil" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://weibo.com/u/3074324883" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="http://www.zhihu.com/people/callmevirgil" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">如何使用公司私有 npm 进行前端开发</h1><div class="post-info">Aug 10, 2018</div><div class="post-content"><p>使用 npm 对前端开发来说已经是必备技能，但是在公司中一般都会搭建公司内部的私有镜像，那么如何使用私有镜像上的模块及发布私有镜像呢？</p>
<h3 id="私有_npm_镜像">私有 npm 镜像</h3><p>1.由于公司内部的 npm 包要上传到公司的私有镜像源，所以首先将 npm 的 registry 重新设置</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">set</span> registry=xxxx <span class="comment">// 私有镜像源</span></span><br></pre></td></tr></table></figure>
<p>2.为了保证能够发布 npm 包，需要有一个 npm 账号</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm adduser --<span class="keyword">registry</span>=<span class="keyword">http</span>://<span class="keyword">registry</span>.npm.baidu-int.com</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="npm_包目录结构">npm 包目录结构</h3><p>一个完整的 npm 包应该由源码、编译后代码、测试用例、文档等组成。</p>
<p>如下图：</p>
<p><img src="http://agroup-bos.su.bcebos.com/e5898520d096202ddc34499b2f674a843cda5d0f" alt="图片"></p>
<p>其中，我们选择使用 ES Module 进行开发，于是选择使用 <code>rollup</code>将代码编译到         <code>cjs</code>,<code>amd</code>等现代浏览器能够支持的模块规范。同时使用 <code>rollup-plugin-babel</code>使我们能够在浏览器不支持的情况下使用箭头函数等新语法。由于 Babel 默认只转换新的 JavaScript 语法，而不转换新的 API。我们再引入 <code>babel-plugin-transform-runtime</code> 插件使我们能够使用 <code>Promise</code> 等新 API。</p>
<p>针对不同的前端模块化方式，我们分别构建不同的文件。<br><code>/dist.dev.js</code>生成的格式为 <code>umd</code>，能够支持直接 <code>script</code> 标签引入和模块语法引入。<code>/dist.common.js</code>生成的格式为 <code>common js</code>，支持 common js 规范的加载器引用这个，如 <code>Webpack &amp; Browserify</code>。<code>/dist.esm.js</code>生成的格式为 <code>ES Modules</code>，支持 ES Modules 规范的加载器引用这个，如<code>Webpack2+ &amp; rollup</code>。</p>
<h3 id="发布">发布</h3><p>由于公司的镜像只支持发布 @baidu 这个 scope 的私有包，所以 <code>package.json</code> 需要需改一下，<code>name</code> 需要加上 scope。目前的 scope 只支持 <code>baidu</code>。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">name</span>": <span class="value"><span class="string">"@baidu/hades"</span></span>,</span><br><span class="line">  "<span class="attribute">version</span>": <span class="value"><span class="string">"1.0.3"</span></span>,</span><br><span class="line">  "<span class="attribute">description</span>": <span class="value"><span class="string">"hades bridge"</span></span>,</span><br><span class="line">  "<span class="attribute">main</span>": <span class="value"><span class="string">"dist/hades.common.js"</span></span>,</span><br><span class="line">  "<span class="attribute">module</span>": <span class="value"><span class="string">"dist/hades.esm.js"</span></span>,</span><br><span class="line">  "<span class="attribute">directories</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">doc</span>": <span class="value"><span class="string">"doc"</span></span>,</span><br><span class="line">    "<span class="attribute">example</span>": <span class="value"><span class="string">"example"</span></span>,</span><br><span class="line">    "<span class="attribute">test</span>": <span class="value"><span class="string">"test"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">scripts</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">build</span>": <span class="value"><span class="string">"rollup --config rollup.config.js --watch"</span></span>,</span><br><span class="line">    "<span class="attribute">test</span>": <span class="value"><span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">repository</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">type</span>": <span class="value"><span class="string">"git"</span></span>,</span><br><span class="line">    "<span class="attribute">url</span>": <span class="value"><span class="string">"xxx"</span> // 代码仓库地址</span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">keywords</span>": <span class="value">[</span><br><span class="line">    <span class="string">"bridge"</span>,</span><br><span class="line">    <span class="string">"wenku"</span>,</span><br><span class="line">    <span class="string">"Hades"</span></span><br><span class="line">  ]</span>,</span><br><span class="line">  "<span class="attribute">author</span>": <span class="value"><span class="string">"xxxx"</span></span>,</span><br><span class="line">  "<span class="attribute">files</span>": <span class="value">[</span><br><span class="line">	<span class="string">"src"</span>,</span><br><span class="line">    <span class="string">"dist"</span>,</span><br><span class="line">    <span class="string">"types/*.d.ts"</span>,</span><br><span class="line">    <span class="string">"types/*.json"</span></span><br><span class="line">  ]</span>,</span><br><span class="line">  "<span class="attribute">license</span>": <span class="value"><span class="string">"ISC"</span></span>,</span><br><span class="line">  "<span class="attribute">devDependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">babel-core</span>": <span class="value"><span class="string">"^6.26.3"</span></span>,</span><br><span class="line">    "<span class="attribute">babel-plugin-external-helpers</span>": <span class="value"><span class="string">"^6.22.0"</span></span>,</span><br><span class="line">    "<span class="attribute">babel-plugin-transform-runtime</span>": <span class="value"><span class="string">"^6.23.0"</span></span>,</span><br><span class="line">    "<span class="attribute">babel-preset-env</span>": <span class="value"><span class="string">"^1.6.1"</span></span>,</span><br><span class="line">    "<span class="attribute">rollup</span>": <span class="value"><span class="string">"^0.58.2"</span></span>,</span><br><span class="line">    "<span class="attribute">rollup-plugin-babel</span>": <span class="value"><span class="string">"^3.0.4"</span></span>,</span><br><span class="line">    "<span class="attribute">rollup-plugin-commonjs</span>": <span class="value"><span class="string">"^9.1.0"</span></span>,</span><br><span class="line">    "<span class="attribute">rollup-plugin-node-resolve</span>": <span class="value"><span class="string">"^3.3.0"</span></span>,</span><br><span class="line">    "<span class="attribute">rollup-watch</span>": <span class="value"><span class="string">"^4.3.1"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">dependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">whatwg-fetch</span>": <span class="value"><span class="string">"^2.0.4"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>更新包的话，coding 完了<code>千万不要</code>直接发布，这里我们需要修改 <code>package.json</code>中 的<code>version</code>版本号，但不能直接修改。</p>
<p>修改之前先说下 npm 维护 package 版本的规则 <code>x.y.z</code>：</p>
<ol>
<li>x 表示主版本号,通常有重大改变或者达到里程碑才改变</li>
<li>y 表示次要版本号,或二级版本号,在保证主体功能基本不变的情况下,如果适当增加了新功能可以更新此版本号</li>
<li>z 表示尾版本号或者补丁号,一些小范围的修修补补就可以更新补丁号</li>
</ol>
<p>对应到 npm 的用法为：<br><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">version</span> patch <span class="comment">// z++</span></span><br><span class="line">npm <span class="keyword">version</span> minor <span class="comment">// y++ &amp;&amp; z=0</span></span><br><span class="line">npm <span class="keyword">version</span> major <span class="comment">// x+= &amp;&amp; y=0 &amp;&amp; z=0</span></span><br></pre></td></tr></table></figure></p>
<p>执行 <code>npm version</code> 的会自动生成对应的版本号并更新 <code>package.json</code><br>，同时在配置了 git 仓库的情况下，会自动生成一个 commit，内容为对应的版本号。</p>
<p>所以，一般更新版本的步骤为：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line">git add .</span><br><span class="line">git commit -m 'xxx'</span><br><span class="line">npm <span class="operator">version</span> patch // 或者 npm <span class="operator">version</span> minor，npm <span class="operator">version</span> major</span><br><span class="line">git push origin HEAD:refs/for/<span class="keyword">master</span></span><br><span class="line"><span class="title">git</span> push origin vx.x.x // npm publish 时会自动生成本地 <span class="operator">tag</span>（<span class="keyword">tag</span> <span class="title">名称为版本号），手动把 tag</span> 发布到远程仓库</span><br><span class="line">npm publish</span><br></pre></td></tr></table></figure>
<h2 id="如何在YOG2项目里使用_npm">如何在YOG2项目里使用 npm</h2><p>在 YOG2 项目可以直接启用 FIS3 配置来使用 npm：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fis3-enable</span></span><br><span class="line"><span class="tag">fis</span><span class="class">.enableNPM</span>(&#123;</span><br><span class="line">    <span class="attribute">autoPack</span>: true</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后在 client 目录下执行</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">npm</span> <span class="comment">install</span> <span class="comment">@baidu/hades</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">save</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">registry=xxx</span></span><br></pre></td></tr></table></figure>
<p>这时 client 目录下会新增 <code>package.json</code> 文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">name</span>": <span class="value"><span class="string">"test"</span></span>,</span><br><span class="line">  "<span class="attribute">version</span>": <span class="value"><span class="string">"0.0.1"</span></span>,</span><br><span class="line">  "<span class="attribute">description</span>": <span class="value"><span class="string">"test"</span></span>,</span><br><span class="line">  "<span class="attribute">author</span>": <span class="value"><span class="string">"xxx"</span></span>,</span><br><span class="line">  "<span class="attribute">private</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">  "<span class="attribute">scripts</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">test</span>": <span class="value"><span class="string">""</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">dependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">@baidu/hades</span>": <span class="value"><span class="string">"^1.0.3"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>这样在前端直接使用 <code>require(&#39;@baidu/hades&#39;)</code>就会直接去<code>node_modules</code>里面寻找同名的包了。</p>
<p>同时，如果启用了 <code>fis3-parser-babel-6.x</code> 插件的话，也可以通过 ESModuels 引入。</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">'client</span>/&#123;components,view&#125;/**.js': &#123;</span><br><span class="line">    <span class="keyword">parser</span>: fis.plugin(<span class="symbol">'babel</span>-<span class="number">6.</span>x'),</span><br><span class="line">    isMod: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Hades <span class="keyword">from</span> <span class="string">'@baidu/hades'</span>;</span><br></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2018/08/15/安卓移动端滑动不支持touchend事件bug/" class="prev">上一篇</a><a href="/2018/06/15/APP中H5页面0.5px边框实现/" class="next">下一篇</a></div><div data-thread-key="2018/08/10/如何使用公司私有 npm 进行前端开发/" data-title="如何使用公司私有 npm 进行前端开发" data-url="http://hellowvirgil.github.io/2018/08/10/如何使用公司私有 npm 进行前端开发/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"true"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2019 <a href="http://hellowvirgil.github.io">Virgil</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>